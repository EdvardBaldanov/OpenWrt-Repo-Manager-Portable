#!/usr/bin/env python3
import threading
import paths
import repo_sync
import repo_publish
from logger_utils import logger

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–∫ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
update_lock = threading.Lock()

def run_all():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (Sync + Publish)."""
    if update_lock.locked():
        logger.warning("‚ö†Ô∏è –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–æ! –ü—Ä–æ–ø—É—Å–∫.")
        return False

    with update_lock:
        logger.info("üîÑ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...")
        
        # 1. –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ)
        # repo_sync.run() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True, –µ—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∏–ª–∏ –µ—Å–ª–∏ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
        # –í –Ω–∞—à–µ–π –ª–æ–≥–∏–∫–µ, –µ—Å–ª–∏ sync –≤–µ—Ä–Ω—É–ª False (–æ—à–∏–±–∫–∞), —Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–µ–º—Å—è.
        if not repo_sync.run():
            logger.error("‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π. –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
            return False

        # 2. –ó–∞–ø—É—Å–∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ (—Å–±–æ—Ä–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤)
        # repo_publish.run() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç True/False
        if not repo_publish.run():
            logger.error("‚ùå –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å.")
            return False
            
        logger.info("‚úÖ –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω.")
        return True

if __name__ == "__main__":
    run_all()
